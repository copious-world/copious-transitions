<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="author" content="Richard Leddy" />
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
	<meta id="theme-color" name="theme-color" content="#452770">
	<link rel="canonical" href="http://www.popsongnow.com">
	<title>Pop Song Now</title>
	<meta name="description" content="Make you songs safe as soon as you think of them.">
	<style>
		/*csslint important:false*/
/* ==========================================================================
   Pure Base Extras
   ========================================================================== */

/**
 * Extra rules that Pure adds on top of Normalize.css

html {

}
*/

/**
 * Always hide an element when it has the `hidden` HTML attribute.
 */

.hidden,
[hidden] {
    display: none !important;
}

/**
 * Add this class to an image to make it fit within it's fluid parent wrapper while maintaining
 * aspect ratio.
 */
.pure-img {
    max-width: 100%;
    height: auto;
    display: block;
}

	.items {
		display: flex;
		flex-wrap: wrap;
		margin-left: 2px;
		margin-top: 0px;
	}

	.items .item {
		flex: 1 0 300px;
		box-sizing: border-box;
		background: -webkit-linear-gradient(to right, rgba(242, 242, 210, 0.3), white);
		background: linear-gradient(to right, rgba(242, 242, 210, 0.3), white );
		color: #171e42;
		padding: 6px;
		margin-left: 10px;
		margin-top: 0px;
	}

	.item {
		height : max-content;
	}

	.items .extra-i {
		padding-left: 10%;
		padding-bottom: 4px;
		padding-right: 12px;
		font-size: 110%;
		font-family: sans-serif;
	}

	.middleBanner {
		text-align: 'center';
		padding-left: 10%;
		padding-right: 10%;
		font-weight:bold;
		color: darkgreen;
		padding-top:4%;
		overflow:auto;
	}

	.applink {
		padding:3px;
		background-color: cornsilk;
		width:inherit;
		min-height: 100%;
		color:darkolivegreen;
		font-weight: bolder;

	}

	.extraBanner {
		text-align: 'center';
		padding-left: 10%;
		padding-right: 10%;
		font-weight:bold;
		color: #FF4400;
		padding-top:4%;
	}


	.fillLowerWrap {
		width: 66%;
		margin-left:0px;
		margin-right:0px;
		padding: 8px;
		margin-top:8px;
		background: -webkit-linear-gradient(to right, white, #FAFAFF);
		background: linear-gradient(to right, white, #FAFAFF );
		margin-left: 10px;
	}

	.fitMenuLower {
		width: 95%;
		height: 50%;
		margin-left:0px;
		margin-right:0px;
		padding: 8px;
		margin-top:8px;
		background: -webkit-linear-gradient(to right, white, #FAFAFF);
		background: linear-gradient(to right, white, #FAFAFF );
		margin-left: 10px;
	}

	#squashMenu:hover {
		border: 1px solid rgb(230,230,240,0.4);
		padding-top:4px;
		background-color: #EFEFEF;
	}

	#squashMenuContainer {
		position:absolute;
		visibility:hidden;
		top : 0; left : 0;
		height:100%;
		width: 55%;
		z-index:100;
		border: rgba(252, 190, 190, 0.4) 2px solid;
		background-color: white;
	}

	.fade_able {
		position:absolute;
		visibility:hidden;
		top : 10px; left : 10px;
		height:80%;
		width: 40%;
		z-index:101;
		border: rgba(252, 190, 190, 0.4) 2px solid;
		background-color: white;
		overflow:hidden;
	}

	.solid_able {
		position:absolute;
		visibility:hidden;
		top : 10px; left : 10px;
		height:80%;
		width: 40%;
		z-index:111;
		border: rgba(252, 190, 190, 0.4) 2px solid;
		background-color: white;
		overflow: hidden;
	}

	@media screen and (max-width: 950px) {
		.solid_able {
			width: 90%;
		}
	}

	#thankyou_box {
		position:absolute;
		visibility:hidden;
		top : 25%; left : 25%;
		height:50%;
		width: 50%;
		z-index:150;
		border: rgba(100, 5, 5, 0.6) 2px solid;
		background-color: lightgoldenrodyellow;
		overflow: auto;
	}

	@media screen and (max-width: 1040px) {
		.fade_able {
			width: 60%;
		}
	}

	@media screen and (max-width: 600px) {
		.fade_able {
			width: 90%;
		}
	}

	.fade_able_content {
		height:100%;
		width: 100%;
		overflow:auto;
	}

	.togglebar {
		height:20px;
		visibility:inherit;
		background-color: navy;
		text-align:right;
	}

	.closer_x {
		padding:2px;
		color:purple;
		font-weight:bolder;
		border: solid 1px red;
		cursor:pointer;
	}

	@media (max-width: 1225px) {
		.fillLowerWrap {
			visibility : "none";
			height : 0px;
		}
	}


	.fillLower {
		border: darkred 2px solid;
		height: 96%;
		width: 96%;
		margin-left: 10px;
		padding:8px;
		background: -webkit-linear-gradient(to right, rgba(252, 252, 240, 0.4), #FEFEFE);
		background: linear-gradient(to right, rgba(252, 252, 240, 0.4), #FEFEFE );
	}

	button {
		cursor: pointer;
		font-size: 85%;
		font-weight: bold;
		color: darkblue;
		margin: 2px;
		width:90px;
	}

	button:hover {
		background-color : #CACAFF;
		color: darkred;
	}

	@media screen and (max-width: 390px) {
		.items .extra-i {
			padding-left: 1%;
		}
	}

	@media screen and (max-width: 600px) {
		.items .extra-i {
			padding-left: 3%;
		}
	}

	.longviz {
		visibility : "visibile";
		height: 10px;
		background-color:inherit;
	}

	@media (max-width: 1040px) {
		.longviz {
			visibility : "none";
			height : 0px;
		}
	}

	.shortviz {
		visibility : "none";
		height:0px;
		margin-top:6px;
	}

	@media (max-width: 620px) {
		.shortviz {
			visibility : "visible";
			height:2px;
			background-color:darkgreen;
			margin-bottom:12px;
		}
	}

	@media (min-width: 1040px) {
		.shortviz {
			visibility : "visible";
			height:120px;
			border: 2px darkblue solid;
			background-color:#FFFFF6;
			margin-bottom:30px;
			margin-top:5px;
		}
	}

	@media (min-width: 380px) {
		.items .item {
			max-width: calc(100% - 20px);
		}
		.items .extra-i {
			padding-left: 3%;
		}
	}
	@media (min-width: 410px) {
		.items .item {
			max-width: calc(100% - 10px);
		}
	}
	@media (min-width: 620px) {
		.items .item {
			max-width: calc(50% - 10px);
		}
	}
	@media (min-width: 830px) {
		.items .item {
			max-width: calc(50% - 10px);
		}
	}
	@media (min-width: 1040px) {
		.items .item {
			max-width: calc(33.33333% - 10px);
		}
	}
	@media (min-width: 1250px) {
		.items .item {
			max-width: calc(25%- 10px);
		}
	}
	@media (min-width: 1460px) {
		.items .item {
			max-width: calc(20% - 10px);
		}
	}
	@media (min-width: 1670px) {
		.items .item {
			min-width: calc(16.66667% - 10px);
		}
	}


	body {
		border: 1px solid black;
		
		-moz-box-sizing: border-box;
		box-sizing: border-box;
	}


	@media screen and (orientation: portrait) {
		#mainNav {
			width: 100%;
		}
	}

	@media screen and (orientation: landscape) {
		#mainNav {
			width: 100%;
		}
	}

	main {
		border-left: solid 3px navy;
		border-top: solid 1px #8833BB;
		padding : 4px;
	}

	#mainNav {
		font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;
		font-weight: 700;
		text-transform: capitalize;
		color : rgb(4, 4, 107);
		background: blue;
		border-left: solid 3px navy;
		border-top: solid 3px navy;
		border-bottom: solid 3px rgba(252,252,255,0.7);
		min-height: 90px
		padding: 20px
		background: -webkit-linear-gradient(to left, rgba(242, 242, 210, 0.3), white);
		background: linear-gradient(to left, rgba(242, 242, 210, 0.3), white );
		
	}

	#mainNav table {
		padding-left: 3%;
	}


	#mainNav  table  a:focus { outline: none; }
	#mainNav  table  .navbar-brand {
		font-size: 1.1rem;
		color: white;
	}

	#mainNav  table  .navbar-brand.active, #mainNav .navbar-brand:active, #mainNav .navbar-brand:focus, #mainNav .navbar-brand:hover {
		color: white;
	}

	#mainNav  table  .navbar-nav {
		letter-spacing: 1px; }

	#mainNav  table  .navbar-nav li.nav-item {
		display:inline;
	}

	
	
	#mainNav  table  .navbar-nav li.nav-item a.nav-link {
		color: darkgreen;
		text-decoration: none;
		vertical-align: top;
		padding-right: 10px;
	}

	#mainNav  table  .navbar-nav li.nav-item a.nav-link:hover {
		color: #18BC9C;
		outline: none;
		
	}


	#mainNav  table  .navbar-nav a.nav-text {
		background-color : rgba(242,222,255,0.6);
		border-radius: 25px;
		margin-bottom: 9px;
		margin-right: 6px;
		white-space: nowrap;
	}


	#mainNav  table  .navbar-nav li.nav-item a.nav-link:active, #mainNav .navbar-nav li.nav-item a.nav-link:focus { color: white; }
	
	.footer-list li {
		list-style-type: none;
	}

	.footer-list li a:hover { color: gold; }
	
	.hover_group {
		cursor:pointer;
	}

	.hover_group rect {
		fill:#e6e6e6;
	}

	.hover_group:hover rect {
		fill: #F6F6e6;
	}

	footer {
		padding:10px;
		background: -webkit-linear-gradient(to left, rgba(252,252,255,0.5), #fffbe2 );
		background: linear-gradient(to left, rgba(252,252,255,0.5), #fffbe2  );
		text-align: center;
		font-size: 0.85em;
	}

	footer a {
		text-decoration:none;
		color:darkgreen;
		font-weight:bold;
		font-style: italic;
	}

	.copiouslink {
		fill:black;
	}
	.copiouslink:hover {
		fill:navy;
	}

	* {margin: 0; padding: 0; box-sizing: border-box}
	
	.PhIOtjDr_0 {
		fill:none;
		stroke:#1c1448;
		stroke-width:4.59875107;
		stroke-miterlimit:4;
		stroke-dasharray: 2948 2950;
		stroke-dashoffset: 2949;
		animation: PhIOtjDr_draw 6666ms ease-in forwards;
	}

	@keyframes PhIOtjDr_draw {
		100% {stroke-dashoffset: 0}
	}

	@keyframes PhIOtjDr_fade {
		0% {stroke-opacity: 1}
		97.1830985915493% {stroke-opacity: 1}
		100% {stroke-opacity: 0}
	}

	.form_el {
		border:lightgray solid 1px;
		padding:6px;
		margin:2px;
		width:80%;
	}

	.form_el_inner {
		border:lightgray solid 1px;
		padding:6px;
		margin:2px;
		width:100%;
	}

	label {
		font-weight:bold;
		color:darkgreen;
		width:35%;
	}

	.field_el {
		width:65%;
	}

	@media (max-width: 1040px) {
		.field_el {
			width:94%;
			margin-left:3%;
			margin-right:3%;
		}
	}

	#contact_box {
		background: -webkit-linear-gradient(to right, rgba(252, 252, 240, 1.0), #FEFEFE);
		background: linear-gradient(to right, rgba(252, 252, 240, 1.0), #FEFEFE );
	}

	.textarea_field_el {
		width: 94%;
		margin:3%;
	}

	.error-message {
		visibility:hidden;
		width:75%;
		font-weight:bolder;
		color:red;
		background-color:white;
		border: solid 1px orange;
		padding:2px;
		margin:3px;
	}

	/* The Modal (background) */
	.modal {
		display: none; /* Hidden by default */
		position: relative; /* Stay in place */
		z-index: 1; /* Sit on top */
		left: 0;
		top: 0;
		width: 100%; /* Full width */
		height: 100%; /* Full height */
		overflow: auto; /* Enable scroll if needed */
		background-color: rgb(0,0,0); /* Fallback color */
		background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
		-webkit-animation-name: fadeIn; /* Fade in the background */
		-webkit-animation-duration: 0.4s;
		animation-name: fadeIn;
		animation-duration: 0.4s
	}

	/* Modal Content */
	.modal-content {
		position: inherit;
		top: 0;
		background-color: #fefefe;
		width: 100%;
		-webkit-animation-name: slideIn;
		-webkit-animation-duration: 0.4s;
		animation-name: slideIn;
		animation-duration: 0.4s
	}

	/* The Close Button */
	.close {
		color: white;
		float: right;
		font-size: 18px;
		font-weight: bold;
	}

	.close:hover,
	.close:focus {
		color: #000;
		text-decoration: none;
		cursor: pointer;
	}

	.modal-header {
		padding: 2px 16px;
		background-color: #4ca85c;
		color: white;
	}

	.modal-body {padding: 2px 16px;}

	.modal-footer {
		padding: 2px 16px;
		margin-bottom: 20px;
		background-color: darkgreen;
		color: white;
	}

	/* Add Animation */
	@-webkit-keyframes slideIn {
		from {bottom: -300px; opacity: 0}
		to {bottom: 0; opacity: 1}
	}

	@keyframes slideIn {
		from {bottom: -300px; opacity: 0}
		to {top: 0; opacity: 1}
	}

	@-webkit-keyframes fadeIn {
		from {opacity: 0}
		to {opacity: 1}
	}

	@keyframes fadeIn {
		from {opacity: 0}
		to {opacity: 1}
	}

	#logout-control-top {
		visibility: hidden;
		display: none;
	}


	#collection {
		max-height: 150px;
		overflow: scroll;
	}

	.editable-line {
		border-bottom: #1c1448 1px solid;
		background-color: #fefefe;
	}
	.editable-line:hover {
		background-color: #feffef;
		cursor: pointer;
	}

	
	.droppable {
		width: 100%;
		height: 80%;
		background-color:transparent;
		position : relative;
		text-align: center;
	}
	.droppable:hover {
		border: 2px dotted rgb(180, 8, 31);
		background-color: rgb(228, 236, 241);
	}
	.dropper_button {
		width: 30%;
	}
	.dropper_controls {
		border: solid 1px rgb(208, 218, 231);
		padding: 3px;
	}
	.droppable > .capture_image {
		position:absolute; 
		top:0px; 
		left:0px; 
		z-index:100; 
		width: auto; 
		height: inherit; 
		border:none;
		cursor:pointer;
	}
	.droppable > .drop-text {
		position:absolute; 
		top:0px; 
		left:0px; 
		z-index:50; 
		width:100%; 
		height:100%; 
		border:none;
	}
	.site-maker-message-box {
		border: 1px solid darkgreen;
		padding: 2px;
		background-color: whitesmoke;
		color:teal;
		font-weight: bolder;
	}

	.site-maker-message-box span {
		color: darkolivegreen;
	}

	#site-builder-user-info {
		border : 1px solid darkgray;
	}

	#hidden-file-div {
		visibility: hidden;
		position:absolute;
		top:0px; 
		left:0px; 
		z-index:50; 
		width:40%; 
		height:20%; 
		border: 2px solid darkorchid;
		background-color: palegoldenrod;
	}

	#floating-info {
		position: absolute;
		visibility: hidden;
		top: 20px;
		left: 20px;
		height:400px;
		width: 60%;
		display: none;
		z-index: 1000;
	}


	#floating-info-entry-title {
		cursor: move;
	}


	#floating-info-entry {
		background-color: ghostwhite;
		padding: 6px;
		border: 1px solid darkslateblue;
		min-height: 200px;
		max-height: 30%;
		overflow: scroll;
	}

	#floating-info-entry-include-abstract {
		display: block;
	}

	#floating-info-special-type-blog {
		background-color: ghostwhite; 
		padding: 6px;
		border: 1px solid darkslateblue;
		min-height: 400px;
		max-height: 50%;
		overflow: scroll;
		display: none;
	}

	#floating-info-special-type-stream {
		background-color: ghostwhite; 
		padding: 6px;
		border: 1px solid darkslateblue;
		min-height: 400px;
		max-height: 80%;
		overflow: scroll;
		display: none;
	}


	#asset-type-stream-poster {
		display: none;
	}

	#asset-type-stream-sound {
		display: none;
	}

	#asset-type-stream-video {
		display: none;
	}

/*
	#asset-type-stream-video-ogg {
		display: inherit;
	}
	#asset-type-stream-video-mpeg {
		display: inherit;
	}
*/
	#floating-info-special-type-demo {
		background-color: ghostwhite; 
		padding: 6px;
		border: 1px solid darkslateblue;
		min-height: 400px;
		max-height: 80%;
		overflow: scroll;
		display: none;
	}

	#floating-info-special-type-links {
		background-color: ghostwhite; 
		padding: 6px;
		border: 1px solid darkslateblue;
		min-height: 400px;
		max-height: 80%;
		overflow: scroll;
		display: none;
	}


		.dboard-title {
			text-transform:capitalize;
			font-size: 0.85em;
		}

		.pub-state {
			font-weight: 500;
			color:whitesmoke;
		}

		.no-view-file-field {
			display: none;
			visibility: hidden;
		}

		.fle_asset_type {
		color:rgb(4, 4, 107);
		font-weight: bold;
	}

	</style>
</head>
<script>
	var g_siteURL = window.location.host;
	var g_finalizers = []
	var g_loginStateViewHolders = {}
</script>
<body>
	
	<nav id="mainNav">
		<table style="width:100%">
			<tr>
				<td style="width:62;height:63">
					<a class="nav-link" href="/">
						<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:xlink="http://www.w3.org/1999/xlink"
   version="1.0"
   width="70"
   height="70"
   viewBox="0 0 350 350"
   preserveAspectRatio="xMidYMid meet"
   id="svg2">
  <defs id="defs16">
    <linearGradient id="linearGradient1115">
      <stop
         style="stop-color:#e9ff00;stop-opacity:1;"
         offset="0"
         id="stop1111" />
      <stop
         style="stop-color:#e9ff00;stop-opacity:0;"
         offset="1"
         id="stop1113" />
    </linearGradient>
    <filter
       style="color-interpolation-filters:sRGB"
       id="filter1107"
       x="-0.02418653"
       width="1.0483731"
       y="-0.023816325"
       height="1.0476327">
      <feGaussianBlur
         stdDeviation="2.8845338"
         id="feGaussianBlur1109" />
    </filter>
    <radialGradient
       xlink:href="#linearGradient1115"
       id="radialGradient1117"
       cx="162.94153"
       cy="166.10171"
       fx="162.94153"
       fy="166.10171"
       r="150.03728"
       gradientTransform="matrix(1,0,0,1.0148269,0,-2.4627807)"
       gradientUnits="userSpaceOnUse" />
  </defs>
  <g
     id="g4232"
     transform="translate(12.8,0)">
    <ellipse
       style="opacity:0.98000004;fill:url(#radialGradient1117);fill-opacity:1;stroke:none;stroke-width:33.07086563;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;paint-order:markers stroke fill;filter:url(#filter1107)"
       id="path833"
       cx="162.94153"
       cy="166.1017"
       rx="143.1144"
       ry="145.33899"
       transform="matrix(1.153994,0,0,1.1209987,-27.316594,-14.907414)" />
    <text
       transform="scale(1.0420353,0.95966038)"
       id="text4170"
       y="109.06458"
       x="144.01936"
       style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:95.65157318px;line-height:125%;font-family:sans-serif;text-align:start;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#ff0080;fill-opacity:1;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
       xml:space="preserve"><tspan
         y="109.06458"
         x="144.01936"
         id="tspan4172"
         style="fill:#ff0080;fill-opacity:1">O</tspan></text>
    <text
       id="text4195"
       y="243.96106"
       x="183.45763"
       style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:64px;line-height:125%;font-family:sans-serif;text-align:start;letter-spacing:0px;word-spacing:0px;writing-mode:lr-tb;text-anchor:start;fill:#000000;fill-opacity:1;stroke:none;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
       xml:space="preserve"><tspan
         y="243.96106"
         x="183.45763"
         id="tspan4197">ong</tspan></text>
    <g
       id="g831"
       transform="translate(23.333334,11.666667)">
      <path
         style="fill:#0000ff;stroke:none"
         id="path12"
         d="m 65.085952,145.23192 c 3.26895,0.045 6.29859,-0.22234 6.72969,-0.55143 0.56359,-0.36425 0.98273,-2.72972 1.12104,-5.34268 0.13832,-2.61297 0.64228,-9.56307 1.1107,-15.43029 1.75701,-23.11592 2.87369,-37.52803 4.261,-58.18425 l 1.48023,-21.485981 11.992232,3.58025 c 10.950016,3.32009 12.621086,3.62804 18.522196,3.51118 14.2188,-0.23097 26.09194,-6.22644 32.52851,-16.25373 2.4006,-3.91106 2.85933,-5.48194 2.68708,-9.83735 -0.37617,-9.346466 -7.6659,-17.341296 -18.99565,-21.097346 -5.54917,-1.80138 -7.57621,-2.06853 -15.22352,-1.97132 -6.88593,0.10985 -10.92611,0.75264 -18.875886,2.86232 -13.283252,3.73975 -20.815682,7.93923 -25.381632,14.196096 -3.51988,4.79849 -3.5614,4.86318 -3.8692,20.24142 -0.38487,16.525811 -3.04833,67.255061 -3.6297,68.160751 -0.37373,0.58223 -7.0047,-2.27387 -12.57569,-5.41127 -8.70357,-4.93602 -17.27674,-12.64393 -20.88808,-18.66294 -7.03283,-11.82005 -7.01766,-25.88617 0.16639,-37.077941 2.45005,-3.81684 2.84156,-4.9405 1.77561,-5.6774 -1.85899,-1.38519 -5.75277,0.39953 -10.36429,4.84365 C 1.9240117,60.39223 -2.0878686,74.17718 4.8798417,89.18116 c 4.3155099,9.37451 7.2958803,12.609 21.4717203,24.08997 17.57938,14.22745 25.23493,21.48113 28.18573,26.81668 1.37651,2.47933 3.09315,4.60004 3.548,4.74769 0.58735,0.1125 3.77324,0.28681 7.00066,0.39642 z"
         />
      <ellipse
         style="fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:2.25200582;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
         id="path4199"
         cx="110.36122"
         cy="26.560381"
         rx="21.172937"
         ry="11.617853" />
    </g>
    <path
       d="m 124.58334,69.729014 c -7.68174,3.748996 -12.93255,7.75361 -18.37783,14.229149 -6.612125,7.92402 -11.279516,16.444467 -13.418726,24.538887 -2.528168,9.3725 -2.333698,25.56135 0.38894,34.84864 l 1.94475,6.64594 -10.598858,8.94648 c -19.8364,16.78527 -31.21315,31.01442 -37.6308,46.69205 -3.50054,8.77605 -4.08397,23.60164 -1.26409,33.99658 2.72264,10.13934 8.65411,19.76744 16.04414,26.41339 7.48727,6.64595 15.26625,10.73577 26.93472,14.31436 8.654109,2.55613 9.918189,2.72654 22.947974,2.81174 l 13.80768,0 1.06961,4.26022 c 6.12594,24.53889 6.32042,27.09503 2.6254,33.31496 -1.94474,3.32297 -9.82095,8.00922 -13.51597,8.00922 -2.72264,0 -3.59777,-1.10766 -1.65303,-2.21532 2.23646,-1.19286 4.76462,-7.6684 4.76462,-12.52506 0,-13.97353 -15.46071,-22.57918 -30.143524,-16.70007 -15.36349,6.04951 -19.25298,21.72714 -8.65411,35.27464 13.807678,17.80774 37.047364,20.27867 55.230724,5.87912 12.34912,-9.71331 16.04414,-27.18023 10.40438,-48.82216 -1.36132,-5.28269 -2.52817,-9.96893 -2.52817,-10.39496 0,-0.34082 1.65304,-1.53368 3.59778,-2.55613 10.30714,-5.6235 20.71152,-15.3368 25.8651,-24.19807 4.66738,-8.09443 5.93147,-13.63272 5.93147,-25.13532 -0.0972,-9.79852 -0.29172,-11.16179 -3.01436,-17.29651 -5.34804,-11.67301 -13.22426,-18.74499 -25.96233,-23.17562 -7.39003,-2.55613 -15.46072,-3.749 -24.40654,-3.8342 l -5.93147,0 -2.33369,-10.13933 -2.33369,-10.13934 4.37567,-4.60104 c 12.25189,-12.69547 23.5314,-27.86186 27.12918,-36.29711 1.16685,-2.55613 2.72264,-8.43523 3.59778,-12.95108 1.55579,-7.6684 1.55579,-8.69085 0,-15.422007 C 146.75342,81.40203 137.32142,67.17288 132.07061,67.17288 c -1.26409,0 -4.57015,1.192862 -7.48727,2.556134 z m 4.66739,19.937843 c 1.16684,1.53369 2.52817,5.027068 3.11159,7.668411 2.52817,10.735762 -5.34805,26.328182 -19.35021,38.597622 -1.75027,1.53368 -3.59777,2.81176 -3.98672,2.81176 -2.52817,0 -2.91712,-21.55674 -0.58342,-28.79912 2.43093,-7.24239 6.90384,-13.973533 12.44636,-18.830192 2.72264,-2.385725 5.25081,-4.345432 5.63976,-4.345432 0.38894,0 1.65303,1.278071 2.72264,2.896951 z m -26.643,94.406573 1.26409,4.85665 -4.764625,2.72654 c -5.639751,3.15257 -12.543599,9.62811 -15.071759,14.14395 -1.45856,2.55613 -1.84751,5.11227 -1.84751,11.75821 0,10.30975 1.94474,14.48476 10.015428,21.64194 5.737001,5.11226 7.681741,4.94186 5.542521,-0.34082 -1.847501,-4.43063 -1.750271,-4.68624 0.58343,-10.13933 2.041975,-4.85666 8.751345,-12.86587 10.793325,-12.86587 0.68066,0 3.20882,9.4577 6.51489,24.02765 4.37567,19.25622 5.25081,24.19808 4.1812,24.5389 -2.62541,0.85204 -15.46072,0.34081 -21.392185,-0.85205 -13.029779,-2.72654 -22.850739,-9.20208 -28.490509,-18.9154 -3.20882,-5.53828 -3.30606,-5.96431 -3.20882,-16.01844 0,-9.37249 0.29171,-10.82097 3.11159,-17.29651 1.75027,-3.9194 4.47291,-8.86126 6.22319,-11.07658 4.86186,-6.30513 15.07176,-16.87048 20.030858,-20.70468 3.889491,-2.98217 4.667386,-3.23777 4.861856,-1.95971 0.19448,0.93725 0.97237,3.8342 1.65303,6.47555 z m 39.67278,26.24297 c 10.01544,3.32298 15.26624,10.99138 15.26624,22.57919 0,11.07658 -5.63975,20.10826 -15.46071,24.96491 l -3.88949,1.95971 -0.58342,-1.95971 c -0.29171,-1.10765 -2.43093,-10.22454 -4.86186,-20.27866 -2.52817,-10.05413 -4.86186,-19.68224 -5.25081,-21.30113 -0.48619,-1.61888 -1.16685,-4.0046 -1.45856,-5.36787 l -0.58342,-2.30053 5.73699,0 c 3.50054,0 7.97345,0.68164 11.08504,1.70409 z"
       id="path8"
       style="fill:#ff0000;stroke:none" />
    <g
       id="g827"
       transform="translate(-11.864407,57.641243)">
      <path
         d="m 234.35149,146.71497 c 3.26895,0.045 6.29859,-0.22234 6.72969,-0.55143 0.56359,-0.36425 0.98273,-2.72972 1.12104,-5.34268 0.13832,-2.61297 0.64228,-9.56307 1.1107,-15.43029 1.75701,-23.11592 2.87369,-37.528029 4.261,-58.184249 l 1.48023,-21.485981 11.99223,3.58025 c 10.95001,3.32009 12.62108,3.62804 18.52219,3.51118 14.2188,-0.23097 26.09194,-6.22644 32.52851,-16.25373 2.4006,-3.91106 2.85933,-5.48194 2.68708,-9.83735 -0.37617,-9.346466 -7.6659,-17.3412962 -18.99565,-21.0973462 -5.54917,-1.80138 -7.57621,-2.06853 -15.22352,-1.97132 -6.88593,0.10985 -10.92611,0.75264 -18.87588,2.86232 -13.28325,3.7397502 -20.81568,7.9392302 -25.38163,14.1960962 -3.51988,4.79849 -3.5614,4.86318 -3.8692,20.24142 -0.38487,16.525811 -3.04833,67.25506 -3.6297,68.16075 -0.37373,0.58223 -7.0047,-2.27387 -12.57569,-5.41127 -8.70357,-4.936019 -17.27674,-12.643929 -20.88808,-18.662939 -7.03283,-11.82005 -7.01766,-25.88617 0.16639,-37.077941 2.45005,-3.81684 2.84156,-4.9405 1.77561,-5.6774 -1.85899,-1.38519 -5.75277,0.39953 -10.36429,4.84365 -15.73297,14.748571 -19.74486,28.533521 -12.77714,43.537501 4.3155,9.374509 7.29588,12.608999 21.47172,24.089969 17.57938,14.22745 25.23493,21.48113 28.18573,26.81668 1.37651,2.47933 3.09315,4.60004 3.548,4.74769 0.58735,0.1125 3.77324,0.28681 7.00066,0.39642 z"
         id="path823"
         style="fill:#176431;fill-opacity:1;stroke:none" />
      <ellipse
         ry="11.617853"
         rx="21.172937"
         cy="26.560381"
         cx="278.33157"
         id="ellipse4230"
         style="fill:#ffffff;fill-opacity:1;stroke:none;stroke-width:2.25200582;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
    </g>
  </g>
</svg>

					</a>
				</td>
				<td  style="text-align:center">
                    <span id="header_user_name" > </span> :: <span class="dboard-title" >dashboard</span>
				</td>
				<td>
					&nbsp;
				</td>
			</tr>
		</table>
	</nav>


	<main>
		<!--  -->
		<div class="items">
			<div class="item">
				<div style="height: fit-content;text-align: center;border-bottom: 1px solid darkslateblue;">
					<h4 id="email"></h4>
				</div>
				<div style="border: thistle 2px solid;padding: 4px;background-color: rgb(248, 238, 220);">
					<span id="date" style="text-decoration: underline;color: rgb(88, 13, 13);">
						
					</span>
					<br>
					<span id="tag_line">
						
					</span>
					<br>
				</div>
				<div id ='dashboard_text' style="border: thistle 2px solid;padding: 4px;background-color: rgb(247, 236, 216);" >
					
				</div>
			</div>			
			<!--  -->
			<div  style="width: 70%">
				<div style="height: fit-content;text-align: center;border-bottom: 1px solid darkslateblue;">
					<h4 id="collection-title" style="text-transform: capitalize;">Links by line</h4>
				</div>
				<div style="height: fit-content;text-align: left;padding-left: 10px; background-color: floralwhite;">
					checked:  <button onclick="publish_checked()">publish</button>
					<button onclick="unpublish_checked()">unpublish</button>
					<button onclick="reload_checked()">reload</button>
					<button onclick="delete_checked()">delete</button>
				</div>
				<div id="collection"  style="border: thistle 2px solid;padding: 4px;background-color: rgb(251, 255, 245);"  >
					<input id="c1" class="collection-functional" type="checkbox" /> 
					<span class="editable-line" id="span-c1" onclick="edit_entry(event)" >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c2" class="collection-functional" type="checkbox" /> 
					<span class="editable-line" id="span-c2" onclick="edit_entry(event)"  >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c3" class="collection-functional" type="checkbox" />
					<span class="editable-line" id="span-c3"  onclick="edit_entry(event)" >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c4" class="collection-functional" type="checkbox" />
					<span class="editable-line"id="span-c4"  onclick="edit_entry(event)" >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c5" class="collection-functional" type="checkbox" />
					<span class="editable-line" id="span-c5" onclick="edit_entry(event)"  >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c6" class="collection-functional" type="checkbox" /> 
					<span class="editable-line" id="span-c6"  onclick="edit_entry(event)" >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c7" class="collection-functional" type="checkbox" /> 
					<span class="editable-line" id="span-c7"  onclick="edit_entry(event)" >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c8" class="collection-functional" type="checkbox" /> 
					<span class="editable-line" id="span-c8"  onclick="edit_entry(event)" >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c9" class="collection-functional" type="checkbox" /> 
					<span class="editable-line" id="span-c9"  onclick="edit_entry(event)" >collection collection collection collection collection collection collection collection collection collection collection</span><br>
					<input id="c10" class="collection-functional" type="checkbox" /> 
					<span class="editable-line" id="span-c10"  onclick="edit_entry(event)" >collection collection collection collection collection collection collection collection collection collection collection</span><br>
				</div>
			</div>
			<!--  -->			
		</div>
		<!--  -->
		<div class="items">
			<div class="item" style="border: rgb(173, 145, 173) 2px solid;padding: 4px;background-color: rgb(248, 246, 220);">
				<span id="add-blog" style="text-decoration: underline;color: #000;font-weight: 600;">
					Blog Drop (drag & drop)
				</span><br>
				<button onclick="show_stuff('blog')">list</button>
				<button onclick="get_file('blog')">&plus;</button>
				<input class="no-view-file-field" type="file" name="drop-click-file_loader-blog"  id="drop-click-file_loader-blog" />
				<div class="droppable"  ondrop="dropHandler(event,'blog');" ondragover="dragOverHandler(event,'blog');">
					<br>&nbsp;<br><br>
					<image class="capture_image" src="images/drop-target.png" onclick="capture_clicks(event,'blog')" />
				</div>
			</div>
		<!--  -->
			<div class="item" style="border: rgb(173, 145, 173) 2px solid;padding: 4px;background-color: rgb(248, 246, 220);">
				<span id="add-stream" style="text-decoration: underline;color: #000;font-weight: 600;">
					Stream Drop (drag & drop)
				</span><br>
				<button onclick="show_stuff('stream')" >list</button>
				<button onclick="get_file('stream')">&plus;</button>
				<input class="no-view-file-field" type="file" name="drop-click-file_loader-stream"  id="drop-click-file_loader-stream" />
				<div class="droppable"  ondrop="dropHandler(event,'stream');" ondragover="dragOverHandler(event,'stream');">
					<br>&nbsp;<br><br>
					<image class="capture_image" src="images/drop-target.png" onclick="capture_clicks(event,'stream')" />
				</div>
			</div>
		<!--  -->
			<div class="item" style="border: rgb(173, 145, 173) 2px solid;padding: 4px;background-color: rgb(248, 246, 220);">
				<span id="add-demo" style="text-decoration: underline;color: #000;font-weight: 600;">
					Demo Drop (drag & drop)
				</span><br>
				<button onclick="show_stuff('demo')" >list</button>
				<button onclick="get_file('demo')">&plus;</button>
				<input class="no-view-file-field" type="file" name="drop-click-file_loader-demo"  id="drop-click-file_loader-demo" />
				<div class="droppable"  ondrop="dropHandler(event,'demo');" ondragover="dragOverHandler(event,'demo');">
					<br>&nbsp;<br><br>
					<image class="capture_image" src="images/drop-target.png" onclick="capture_clicks(event,'demo')" />
				</div>
			</div>
		<!--  -->
			<div class="item" style="border: rgb(173, 145, 173) 2px solid;padding: 4px;background-color: rgb(248, 246, 220);">
				<span id="add-links" style="text-decoration: underline;color: #000;font-weight: 600;">
					Link Package Drop (drag & drop)
				</span><br>
				<button onclick="show_stuff('links')" >list</button>
				<button onclick="get_file('links')">&plus;</button>
				<input class="no-view-file-field" type="file" name="drop-click-file_loader-links"  id="drop-click-file_loader-links" />
				<div class="droppable"  ondrop="dropHandler(event,'links');" ondragover="dragOverHandler(event,'links');">
					<br>&nbsp;<br><br>
					<image class="capture_image" src="images/drop-target.png" onclick="capture_clicks(event,'links')" />
				</div>

			</div>
		<!--  -->
		</div>
	</main>


	<footer>
		<ul class="footer-list">
			<li>
				<a href="http://www.popsongnow.com">copyright &copy; 2020 popsongnow.com</a>
			</li>
		</ul>
	</footer>
	
	<div id="floating-info">
		<div style="cursor:pointer;text-align:center;width: 100%;background-color:lightgreen;height: 24px;color: #000;font-weight:bold;padding-top:2px;border: solid 1px magenta;vertical-align: middle;" >
			<span id="floating-info-entry-title" style="float: left;padding-left:20%;"> title </span><span  onclick="hide_window('floating-info')" style="float:right;background-color: #e6e6e6;color:rgb(4, 44, 4)">X</span>
		</div>
		<div class="droppable"  style="vertical-align:middle;text-align:center;max-height:40px;background-color: rgb(250, 248, 248);border: 1px solid rgb(4, 44, 4)" ondrop="dropHandlerUpdates(event);" ondragover="dragOverHandler(event,'update');">
			Drop Replacement Content Here For &gt;&gt; <span class="fle_asset_type" id='floating-info-entry-asset_type' >..</span>
			<image class="capture_image" src="images/drop-target.png" onclick="capture_clicks(event,'update')" />
		</div>
		<div id="floating-info-entry-controls" style="width: 100%;background-color:rgb(215, 233, 240);height:fit-content;text-align:right;vertical-align: middle;padding-top: 4px;padding-right: 6px;" >
			<span >title:</span> <input type="text" id="floating-info-entry-title-field" value="" >
			<span class="pub-state" id='floating-info-entry-published' >tt</span>
			<button onclick="save('current-display-item')">save</button>&nbsp;
			<button id='floating-info-entry-do-undo' onclick="undo_data_drop('current-display-item')">undo</button>&nbsp;
			<button id='floating-info-entry-do-publish' onclick="publish('current-display-item')">publish</button>&nbsp;
			<button id='floating-info-entry-do-unpublish' onclick="unpublish('current-display-item')">unpublish</button>
			<input id='current-display-item' type="hidden" value="something">
			<input id='shareable' type="hidden" value="some agreed upon flag">
		</div>
		<div id="floating-info-entry-include-abstract" style="font-weight: bold;width: 100%;background-color:rgb(234, 245, 240);height:fit-content;text-align:left;vertical-align: middle;padding-top: 4px;padding-right: 6px;border: 1px solid green;">
			Abstract:
		</div>
		<div id="floating-info-entry" contenteditable="true" >
			
		</div>
		<!-- Special fields for entries contain data types in addition to the abstract-->
		<div id="floating-info-special-type-blog"  contenteditable="true" >

		</div>
		<div id="floating-info-special-type-stream" >
			<image id="asset-type-stream-poster" src="images/drop-target.png" height="120px" />
			<audio id="asset-type-stream-sound" controls controlsList="nodownload"  >
				<source id="asset-type-stream-sound-ogg" src="" type="audio/ogg">
				<source id="asset-type-stream-sound-mpeg" src="" type="audio/mpeg">
			</audio>
			<video id="asset-type-stream-video" src="" poster="" width="320" height="240" controls />
		</div>
		<div id="floating-info-special-type-links" >

			<ul id="asset-type-links-list" >
			</ul>

		</div>
		<div id="floating-info-special-type-demo" >

		</div>

	</div>


</body>
</html>
<!--
<script src="https://unpkg.com/ipfs@latest/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hlsjs-ipfs-loader@latest/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
-->
<script>
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
var g_ipfs_node = false
//
document.addEventListener('DOMContentLoaded', async () => {
	setup_ipfs_node()
})

//
function displayError(err) {
	const modalElement = document.getElementById('modal');
	if ( modalElement ) {
		modalElement.style.display = 'flex';
		const errStr = String(err).toLowerCase();
		const spanElement = document.getElementById('errorText');
		spanElement.innerHTML = errStr.includes('SecurityError'.toLowerCase())
												? 'You must use Chrome or Firefox to test this embedded app!' 
												: 'Something went wrong. See the console to get further details.';
  }
}



// Setting HLS Config values
/*
Hls.DefaultConfig.loader = HlsjsIpfsLoader
Hls.DefaultConfig.debug = false
*/

function store_encrypted(data) {
	return(data)
}
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----


// Make the DIV element draggagle:

function dragElement(floater_id,float_header_id) {

	let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

	let floater = document.getElementById(floater_id)
	let floater_h_bar = document.getElementById(float_header_id)

	if ( floater === undefined ) return
	if ( floater_h_bar === undefined ) return

	floater_h_bar.onmousedown = (e) => {
										e = e || window.event;
										e.preventDefault();
										// get the mouse cursor position at startup:
										pos3 = e.clientX;
										pos4 = e.clientY;
										document.onmouseup = closeDragElement;
										// call a function whenever the cursor moves:
										document.onmousemove = elementDrag;
									}

	function dragMouseDown(e) {
		e = e || window.event;
		e.preventDefault();
		// get the mouse cursor position at startup:
		pos3 = e.clientX;
		pos4 = e.clientY;
		document.onmouseup = closeDragElement;
		// call a function whenever the cursor moves:
		document.onmousemove = elementDrag;
	}

	function elementDrag(e) {
		e = e || window.event;
		e.preventDefault();
		// calculate the new cursor position:
		pos1 = pos3 - e.clientX;
		pos2 = pos4 - e.clientY;
		pos3 = e.clientX;
		pos4 = e.clientY;
		// set the element's new position:
		let newtop = (floater.offsetTop - pos2)
		let newleft =  (floater.offsetLeft - pos1)
		if ( newtop > 10 ) {
			floater.style.top = newtop + "px";
		}
		if ( newleft > 4 ) {
			floater.style.left = newleft + "px";
		}
	}

	function closeDragElement() {
		/* stop moving when mouse button is released:*/
		document.onmouseup = null;
		document.onmousemove = null;
	}

}



dragElement("floating-info","floating-info-entry-title")

// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----



var g_url_match = /[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)?/gi;
function matches_url(maybe_url) {
	return g_url_match.test(maybe_url)
}

// not_https_switch 
// switch to HTTPS before doing any ops that may require a data exchange
function not_https_switch() {
	if (location.protocol !== 'https:') {           // start from a secure page
		alert("Switching to a secure version of this page in 1sec.")
		setTimeout(()=> {location.replace(`https:${location.href.substring(location.protocol.length)}`)},1000)
		return(true)
	}
	return(false)
}


function clonify(obj) {
	if ( typeof obj === 'string' ) return(obj)
	try {
		let out = JSON.parse(JSON.stringify(obj))
		return(out)
	} catch(e) {
		return(null)
	}
}


// attach a script to a DOM element
function addscript(script,whereScipt) {
	var scriptEl = document.createElement('script');
	scriptEl.type = 'text/javascript';
	scriptEl.text = script;
    if ( typeof whereScipt === "string" ) {
        whereScipt = document.getElementById(whereScipt)
    }
	whereScipt.appendChild(scriptEl);
}


// simple check on cookies, searching by ';' delimited string with the cookie name at the start of the trimmed line.
function getCookie(cname) {  // modified from w3school
	var name = cname + "=";
	var ca = document.cookie.split(';');
	for(let i = 0; i < ca.length; i++) {
		var c = ca[i];
		if ( typeof c === 'string' ) {
			c = c.trim()
			if (c.indexOf(name) == 0) {
				return c.substring(name.length);
			}
		}
	}
	return "";
}


function addstyle(script) {
    var styleEl = document.createElement('style');
    styleEl.type = 'text/css';
    styleEl.text = script;
    let whereScript = document.getElementsByTagName('head')
    if ( whereScript && whereScript.length ) {
        whereScript[0].appendChild(styleEl);
    }
}


//$$EXPORTABLE::
/*
matches_url
clonify
addscript
addstyle
getCookie
*/






//  fetchEndPoint
// //
// fetch with GET method
async function fetchEndPoint(endpoint,port) {
	port = !(port) ? '' : ( port.length ? `:${port}`   : '')
	let myRequest = new Request(`${location.protocol}//${g_siteURL}${port}/${endpoint}`);
	try {
		const body = await fetch(myRequest, {
									method: 'GET', // *GET, POST, PUT, DELETE, etc.
									mode: 'cors', // no-cors, *cors, same-origin
									cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
									credentials: 'omit', // include, *same-origin, omit
									redirect: 'follow', // manual, *follow, error
									referrerPolicy: 'no-referrer', // no-referrer, *client
								});
		//
		let infoObj = await body.json();
		return(infoObj)
		//
	} catch (e) {
		console.log(e.message)
		return(false)
	}
}

//  postData
// //
//  call fetch with method POST tyr to help with parameters..  If data is FromData set do_stringify to false
//  default content type 'application/json'
//  User 'cors', Default cres = omit, If ctype == 'multipart/form-data' be sure to use FormData -- lets fetch set content type.
//  RETURNS: parsed JSON object or an empty object. ... Check for fields
//
async function postData(url = '', data = {}, creds = 'omit', do_stringify = true,ctype) {
	let content_type = 'application/json'
	if ( ctype !== undefined ) {
		content_type = ctype            // ctype is content type
	}
	let options = {
		method: 'POST', // *GET, POST, PUT, DELETE, etc.
		mode: 'cors', // no-cors, *cors, same-origin
		cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
		credentials: creds, // include, *same-origin, omit
		headers: {
			'Content-Type': content_type
		},
		redirect: 'follow', // manual, *follow, error
		referrerPolicy: 'no-referrer', // no-referrer, *client
		body: (do_stringify ? JSON.stringify(data)  : data)	// body data type must match "Content-Type" header
	}

	if ( ctype === 'multipart/form-data') {
		delete options.headers['Content-Type']  // content type will be set automatically with a boundary
	}

	// Default options are marked with *
	const response = await fetch(url, options);
	if ( response.ok == false ) {
		console.log(response.status + ': ' + response.statusText)
		return {}
	} else {
		return await response.json(); // parses JSON response into native JavaScript objects
	}
}


//$$EXPORTABLE::
/*
fetchEndPoint
postData
*/



// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----


const DELETE_STATE_COLOR = "red"
const PUBLISHED_STATE_COLOR = "limegreen"
const UNPUBLISHED_STATE_COLOR = "darkred"

const DELETE_COLOR = "pink" 
const PUBLISHED_COLOR = "limegreen"
const UNPUBLISHED_COLOR = "black"

var g_current_sel_display = "blog"
var g_current_edit_el = null

//
var g_all_user_entries = {
		"blog" : [],
	"stream" : [],
	"demo" : [],
	"links" : []

}

var g_current_entry_dom_map  = {}
var g_undo_list = {
	
	"blog" : {},
	"stream" : {},
	"demo" : {},
	"links" : {}

}

// id to item
var g_unsaved_items = {}


// // // // 
function append_to_container(key,obj) {
	if ( g_current_sel_display === key ) {
		let title = obj.title
		//
		if ( !(obj.decoded) ) title = decodeURIComponent(title)

		let line_color = "black"
		let entries = g_all_user_entries[key]
		let i = entries.length - 1

		if ( obj.deleted ) {
			line_color = DELETE_COLOR
		} else {
			if ( obj.published ) {
				line_color = PUBLISHED_COLOR
			} else {
				line_color = UNPUBLISHED_COLOR
			}
		}

		g_current_entry_dom_map[obj._dash_entry_id] = i

		let from_template = `
				<div id="div-${i}" >
					<input id="c${i}" class="collection-functional" type="checkbox" />
					<span class="editable-line" style="color:${line_color}" id="span-c${i}" onclick="edit_entry(event)" >${title}</span>
				</div>
					`
		let container = document.getElementById('collection')
		container.innerHTML = from_template + container.innerHTML
	}
}


// // // // //

//
let g_code_files = [ ".js", ".c",  ".cpp", ".c++",  ".cc", ".v", ".rs" ]
let g_media_files = [ ".mp3", ".mp4",  ".mpeg", ".ogg",  ".wav", ".jpeg", ".gif", ".png" ]
let g_text_files = [ ".txt", ".text", ".html", ".svg", ".htm" ]


let g_ext_to_media_type = {
	".mp3" : "audio", 
	".mp4" : "video",  
	".mpeg" : "video", 
	".ogg" : "audio",  
	".wav" : "audio", 
	".jpeg" : "image", 
	".gif" : "image",
	".png" : "image",
	//
	".txt" : "text",
	".text" : "text", 
	".html" : "text", 
	".svg" : "text", 
	".htm" : "text",
	//
	".js" : "text", 
	".c" : "text",
	".cpp" : "text",
	".c++" : "text",
	".cc" : "text",
	".v" : "text",
	".rs" : "text"
}




var g_uploader_cache = {}

const DEFINED_CHUNK_SIZE = 5000000
const DEFINED_MAX_SIZE = 9000000

async function finalize_small_media_storage(primary_response) {
	if ( primary_response.transition && primary_response.transition.token ) {
		let transaction_token = primary_response.transition.token
		let protocol = primary_response.elements.protocol
		let media_id = primary_response.elements.media_id
		let url = `http://${g_siteURL}/uploaders/secondary/transition`
		let body = {
			"token" : transaction_token,
			"match" : "handshake",
		}
		body.protocol = protocol
		body.media_id = media_id   // maybe a checksum
		let secondary_resp =  await postData(url,body)
		return [protocol,media_id]
	}
	return [false,false]
}

//
// finalize_media_storage
//	There are likely faster ways of sending the data. But, this way requires some permission and safe guarding by the server sid.
async function finalize_media_storage(primary_response,formdata,blob,obj) {

	let secondary_resp = primary_response

	if ( primary_response.transition && primary_response.transition.token ) {	// A token has to be associated with the transaction
		//
		let transaction_token = secondary_resp.transition.token		// call the transition token the transaction_token
		let protocol = 'p2p-default'				// These fields have no real value until the end, but are always checked in case they may be used for security.
		let media_id = ""
		//
		formdata.set("protocol",protocol)				// Most likely ipfs ... 
		formdata.set("media_id",media_id)				// not set until the storage system can identify 
		formdata.set("token",transaction_token)
		formdata.set("match","upload-next")				// tell the server that you are sending one chunk after another
		formdata.set("next",true)  // NEXT
		formdata.set("_t_match_field",obj.file_name)
		let url = `http://${g_siteURL}/uploaders/secondary/transition`		// generic seconday keyed by the token
		//
		let size_end = blob.size						// total length of the data in flight
		let start = 0;
		let span = DEFINED_CHUNK_SIZE					// application generation sets this (tuning upstream)
		let num_sends = Math.floor(size_end/span) + 1	// size/chunk_size
		//
		for ( let i = 0; i < num_sends; i++ ) {			// the number of times this is called is determined by the client
			//
			let start = i*span
			let end = Math.min((i+1)*span,size_end)
			let blob_part = blob.slice(start,end)  				// next part of the blob
			formdata.set('media_file', new Blob([blob_part]),obj.file_name)
			secondary_resp = await postData(url,formdata, 'omit',false,'multipart/form-data')  // send it as a separate file
			//
			if ( (secondary_resp.OK !== "true") && (secondary_resp.OK !== true) ) {
				break;			// This last send failed. Bailout  (If failed, the server will shutdown the communication)
			}
		}
		//
		if ( (secondary_resp.OK === "true") || (secondary_resp.OK === true) ) {						// The last send was good.
			let body = {
				"token" : transaction_token,
				"match" : "complete",
				"_t_match_field" : obj.file_name,
				"file" : { "name" : obj.file_name },
				"next"	: false		// NO NEXT
			}
			secondary_resp =  await postData(url,body)			// Tell the server that this transaction is done...
			let elements = secondary_resp.state.elements			// The good stuff is returned in a state field 
			protocol = elements.protocol  // final hash and provider returned in state (same as for the shor but in the state field)
			media_id = elements.media_id
		}
		//
		return [protocol,media_id]
	}
	return [false,false]
}


// data:[<MIME-type>][;charset=<encoding>][;base64],<data>

async function upload_small(obj,blob_already) {			// 	obj.media_type
	obj.email = g_dashboard_info.email
	let url = `http://${g_siteURL}/uploaders/transition/do_param_upload`
	const mime = obj.mime
	//
	let blob_data = ""
	//
	if ( !(blob_already) )  {
		try {
			let res = await fetch(obj.blob)
			blob_data = await res.blob()
		} catch(e) {
			return
		}
	} else {
		blob_data = blob_already
	}
	//
	let formdata = new FormData()
	for ( let ky in obj ) {
		if ( ky === 'blob' ) continue
		formdata.append(ky, obj[ky])
	}
	formdata.append('protocol', 'p2p-default')
	formdata.append('media_file', new Blob([blob_data]), obj.file_name)
	//
	// in the small versions, the file is sent immediately. No preamble
	//
	let primary_response =  await postData(url,formdata,'omit',false,'multipart/form-data')
	if ( primary_response.OK === "true" ) {
		let media_store_characteristics = await finalize_small_media_storage(primary_response)
		return media_store_characteristics
	} else {
		return [false, false]
	}
}


async function upload_big(obj,blob_already) {
	obj.email = g_dashboard_info.email
	let url = `http://${g_siteURL}/uploaders/transition/do_param_upload`
	const mime = obj.mime
	let blob_data = ""
	//
	if ( !(blob_already) )  {
		try {
			let res = await fetch(obj.blob)
			blob_data = await res.blob()
		} catch(e) {
			return
		}
	} else {
		blob_data = blob_already
	}
	//
	let formdata = new FormData()
	for ( let ky in obj ) {
		if ( ky === 'blob' ) continue
		formdata.append(ky, obj[ky])
	}
	formdata.append('protocol', 'p2p-default')
	formdata.append('preamble',blob_data.size)	// tell the size of data to come
	//
	// in the large versions, a preamble is sent with the size of the data. No data is sent in the first message
	//
	let primary_response =  await postData(url,formdata,'omit',false,'multipart/form-data')
	//
	if ( primary_response.OK === "true" ) {		// If the system can handle the request, start a cycle of sends
		let media_store_characteristics = await finalize_media_storage(primary_response,formdata,blob_data,obj)
		return media_store_characteristics
	} else {
		return [false, false]
	}
}

// ---- ---- ---- ---- ---- ---- ----
async function upload_audio(obj) {
	let blob_data
	try {
		let res = await fetch(obj.blob)
		blob_data = await res.blob()
	} catch(e) {
		return
	}
	if ( blob_data.size > DEFINED_MAX_SIZE ) {
		return await upload_big(obj,blob_data)
	} else {
		return await upload_small(obj,blob_data)
	}
}

// ---- ---- ---- ---- ---- ---- ----
async function upload_image(obj) {
	if ( !(blob_already) )  {
		try {
			let res = await fetch(obj.blob)
			blob_data = await res.blob()
		} catch(e) {
			return
		}
	} else {
		blob_data = blob_already
	}
}

// ---- ---- ---- ---- ---- ---- ----
async function upload_video(obj) {
	return await upload_big(obj)
}


// ---- ---- ---- ---- ---- ---- ----
function prep_upload_for(obj,uploader_fun) {
	//
	g_uploader_cache[obj._dash_entry_id] = async () => {
		return await uploader_fun(obj)
	}
	//
}


// ---- ---- ---- ---- ---- ---- ----
async function do_media_upload(obj) {		// earlier a link was made for the media, which will be uploaded if ever the user "save"s it.
	let id = obj._dash_entry_id
	let _uploader = g_uploader_cache[id]	// _uploader from map
	if ( _uploader ) {
		let [protocol,asset_id] = await _uploader()
		return [protocol,asset_id]
	}
}






const AUDIO_STREAMING_SERVICE = "https://www.popsongnow.com/audio/"
const VIDEO_STREAMING_SERVICE = "https://www.popsongnow.com/video/"
const IMAGE_STORAGE_SERVICE = "https://www.popsongnow.com/images/"

// 
//
// All of these make a link that will server the stored object given its placement into a p2p service cloud.
// The link may be filtered through a service worker that translates it into the p2p pathway such as ipfs.
//
function make_audio_upload_link(obj) {
	let file_name = obj.file_name
	let stream_link = AUDIO_STREAMING_SERVICE + file_name
	prep_upload_for(obj,upload_audio)
	return(stream_link)
}

function make_video_upload_link(obj) {
	let file_name = obj.file_name
	let stream_link = VIDEO_STREAMING_SERVICE + file_name
	prep_upload_for(obj,upload_video)
	return(stream_link)
}

function make_image_upload_link(obj) {
	let file_name = obj.file_name
	let stream_link = IMAGE_STORAGE_SERVICE + file_name
	prep_upload_for(obj,upload_image)
	return(stream_link)	
}


function extract_sound_media_ext(file_src) {
	let dot = file_src.lastIndexOf('.')
	if ( dot < 0 ) return("mpeg") // default .. e.g. from a streaming service
	let ext = file_src.substr(dot)
	if ( ext === '.ogg') return("ogg")
	return("mpeg")
}


function get_ext(fname) {
	let ext = fname.slice((Math.max(0, fname.lastIndexOf(".")) || Infinity) + 1);
	if ( ext.length > 0 ) ext = '.' + ext
	return ext
}


function best_cat_for_ext(ext) {
	if ( g_code_files.indexOf(ext) >= 0 ) return ("blog")
	else if ( g_text_files.indexOf(ext) >= 0 ) return ("blog")
	else if ( g_media_files.indexOf(ext) >= 0 ) return ("stream")
	return("blog")
}


function is_link(file_name) {
	if ( file_name[0] === '/' ) return(true)
	let tester = "http:"
	if ( file_name.substr(0,tester.length) === tester) return true
	tester = "https:"
	if ( file_name.substr(0,tester.length) === tester) return true
	tester = "wss:"
	if ( file_name.substr(0,tester.length) === tester) return true
	tester = "ipfs:"
	if ( file_name.substr(0,tester.length) === tester) return true
	return(false)
}


function check_category(category,file_name) {
	//
	if ( file_name === undefined ) {
		return category
	}
	if ( is_link(file_name) ) {
		return category
	}
	//
	let ext = get_ext(file_name)
	if ( ext.length ) {
		let fit_cat = best_cat_for_ext(ext)
		return(fit_cat)
	}
	//
	return category
}


function add_or_use_url(url) {
	let cat = g_current_sel_display
	// update_edit_display(g_current_edit_el)
	if ( g_current_edit_el ) {
		let el_id = g_current_edit_el.id
		let entry = get_entry(get_id(el_id))
		if ( !(entry) ) return;
		//
		switch ( entry.asset_type ) {
			case "links" : {
				//
				entry.links.push(url)
				break;
			}
			case "stream" : {
				//
				if ( entry.media ) {
					entry.media.source = url
				}
				break;
			}
			default : return
		}
		//
		update_edit_display(g_current_edit_el) 
	}
}


function best_fit_media_type(file_name) {
	//if ( category == 'stream' ) {
		let ext =  get_ext(file_name)
		let mtype = g_ext_to_media_type[ext]
		if ( mtype === undefined ) {
			mtype = 'text'
		}
		return(mtype)
	//}
	//return undefined
}

function sel_display_title(key) {
	let title_field = document.getElementById('collection-title')
	let title_txt = key + " > click on lines"
	title_field.innerHTML = title_txt
}

// // // // // // // // // // // // //
// // // // // // // // // // // // //

function show_stuff(key) {

	sel_display_title(key)

	g_current_sel_display = key
	let entries =  g_all_user_entries[key]
	let container = document.getElementById('collection')

	g_current_entry_dom_map = {}

	let total_txt = ""
	let n = entries.length
	while ( --n >= 0 ) {
		let i = n
		let obj = entries[i]
		let title = obj.title
		if ( !(obj.decoded) ) title = decodeURIComponent(title)

		if ( obj.deleted ) {
			line_color = DELETE_COLOR
		} else {
			if ( obj.published ) {
				line_color = PUBLISHED_COLOR
			} else {
				line_color = UNPUBLISHED_COLOR
			}
		}

		g_current_entry_dom_map[obj._dash_entry_id] = i

		let from_template = `
				<div id="div-${i}" >
					<input id="c${i}" class="collection-functional" type="checkbox" />
					<span class="editable-line" id="span-c${i}" style="color:${line_color}"  onclick="edit_entry(event)" >${title}</span>
				</div>
					`
		total_txt += from_template
	}

	container.innerHTML = total_txt
	if ( is_drop_target_type(key) ) {
		//
		let drop_maker = ((nn) => {
			return () => {
				for ( let i = 0; i < nn; i++ ) {
					make_drop_target(`span-c${i}`,key)
				}
			}
		})(entries.length)
		//
		setTimeout(drop_maker,0)
	}
}


// // // // // // // // // // 
function app_dragstart_handler(ev) {
	ev.dataTransfer.setData("application/link-package", ev.target.id);
	ev.dataTransfer.dropEffect = "move";
}
function app_dragover_handler(ev) {
	ev.preventDefault();
	ev.dataTransfer.dropEffect = "move"
}

function app_anchor_make_dragdrop_source(anchor) {
	if ( anchor ) {
		anchor.addEventListener("dragstart", app_dragstart_handler);
	}
}

function is_drop_target_type(category) {
	if ( category === "links" ) return(true)
	return false
}

var g_drop_handlers = {
	"links" : (ev) => {
		ev.preventDefault();
		const sources_id = ev.dataTransfer.getData("application/link-package");
		let t_el = ev.target
		let drop_el_id = t_el.id

		//
		let [key,index,src_app_id] = sources_id.split('-')
		let src_entry = get_object(src_app_id)
		let dst_app_id = get_id(drop_el_id)
		let dst_entry = get_object(dst_app_id)
		if ( src_entry.asset_type === 'links' ) {
			try {
				let link_in_trans = src_entry.links[index]
				dst_entry.links.push(link_in_trans)
				src_entry.links.splice(index,1)
				src_entry.published = false
				dst_entry.published = false
				//
				g_unsaved_items[src_app_id] = src_entry
				g_unsaved_items[dst_app_id] = dst_entry
				if ( g_current_edit_el ) {
					update_edit_display(g_current_edit_el) 
				}
			} catch (e) {
			}
		}
		//
	}
}


function make_drop_target(dropper_id,key) {
	let dropper = document.getElementById(dropper_id)
	if ( dropper !== undefined ) {
		let drop_hanlder = g_drop_handlers[key]
		if ( drop_hanlder && ( typeof drop_hanlder === 'function') ) {
			dropper.addEventListener("dragover", app_dragover_handler);
			dropper.addEventListener("drop", drop_hanlder);
		}
	}
}


function category_name_get(key) {
	let name = key + '_' + Math.floor(Math.random()*5000)
	return name
}

function get_index(id) {
	let index = parseInt(id.split('-')[1].trim().substr(1))
	return index
}

function get_object(item_id)  {
	let entries = g_all_user_entries[g_current_sel_display]
	for ( let i = 0; i < entries.length; i++ ) {
		if ( entries[i]._dash_entry_id == item_id ) {
			return entries[i]
		}
	}
	return false 
}

function get_entry(index) {
	let entries = g_all_user_entries[g_current_sel_display]
	let entry = (index < entries.length) ? entries[index] : false
	return entry
}

function get_asset_type(id) {
	let index = get_index(id)
	let entry = get_entry(index)
	let at = entry ? entry.asset_type : ""
	return (at)
}

function get_data(id) {
	let index = get_index(id)
	let entry = get_entry(index)
	let data = entry ? entry.data : ""
	if ( data === undefined ) {
		data = entry.txt_full
		if ( data ) {
			entry.data = data
		} else data = ""
	}
	if ( !(entry.decoded) ) data = decodeURIComponent(data)
	return (data)
}

function get_title(id) {
	let index = get_index(id)
	let entry = get_entry(index)
	let title = entry ? entry.title : ""
	if ( title.length && !(entry.decoded) ) title = decodeURIComponent(title)
	return (title)
}

function get_id(id) {
	let index = get_index(id)
	let entry = get_entry(index)
	return (entry ? entry._dash_entry_id : -1)
}

function get_is_sent(id) {
	let index = get_index(id)
	let entry = get_entry(index)
	return (entry ? entry.sent : false)
}

function get_is_published(id) {
	let index = get_index(id)
	let entry = get_entry(index)
	return (entry ? entry.published : false)
}


function get_is_del(id) {
	let index = get_index(id)
	let entry = get_entry(index)
	return (entry ? entry.deleted : false)
}

function get_line_element(obj) {
	let index = g_current_entry_dom_map[obj._dash_entry_id]
	return(`span-c${index}`)
}



// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----

function update_edit_display(el) {
	g_current_edit_el = el
	let op_button_1 = document.getElementById('floating-info-entry-do-publish')
	let op_button_2 = document.getElementById('floating-info-entry-do-unpublish')
	op_button_1.disabled = false
	op_button_2.disabled = false
	//
	text = get_title(el.id)
	let where_data = document.getElementById('floating-info-entry-title')
	where_data.innerHTML = text

	let title_el = document.getElementById('floating-info-entry-title-field')
	title_el.value = text
	//
	let contents_view = document.getElementById('floating-info-entry')
	contents_view.innerHTML = get_data(el.id)

	let asset_type_view = document.getElementById('floating-info-entry-asset_type')
	let asset_type = get_asset_type(el.id)
	//
	asset_type_view.innerHTML = asset_type
	//
	hide_all_special_data_fields()
	let special_data_field = document.getElementById('floating-info-special-type-' + asset_type)
	if ( special_data_field ) {
		if ( populate_special_fields(asset_type,el.id) ) {
			special_data_field.style.display = "block"
		}
	}
	//
	//
	//
	let is_pub = get_is_published(el.id)
	let is_del = get_is_del(el.id)
	let published = is_pub ? "published" : "draft"
	if ( is_del ) published = "deleted"
	let where_p = document.getElementById('floating-info-entry-published')
	where_p.innerHTML = published
	where_p.style.color = is_pub ? PUBLISHED_STATE_COLOR : UNPUBLISHED_STATE_COLOR
	if ( is_del ) {
		where_p.style.color = DELETE_STATE_COLOR
		where_p.style.fontWeight = "bolder"
		op_button_1.disabled = true
		op_button_2.disabled = true
	}
	if ( is_pub ) {
		op_button_1.disabled = true
	} else {
		op_button_2.disabled = true
	}
	//
	//
	let cur_item_holder = document.getElementById('current-display-item')
	cur_item_holder.value = get_id(el.id)
}


function edit_entry(ev) {
	let el = ev.target //document.getElementById(which)
	let text = ""
	if ( el ) {
		update_edit_display(el)
		let container = document.getElementById('floating-info')
		container.style.display = "block"
		container.style.visibility = "visible"

	}
}


function hide_all_special_data_fields() {
	let known_asset_types = Object.keys(g_all_user_entries)
	for ( let asset_type of known_asset_types ) {
		let special_data_field = document.getElementById('floating-info-special-type-' + asset_type)
		if ( special_data_field ) {
			special_data_field.style.display = "none"
		}
	}
}


async function media_startup(player,codecs,protocol,cid,src) {
	if ( protocol === 'ipfs' ) {
		await ipfs_loader(player,codecs,cid)
	}
	/*
  if (!Hls.isSupported()) {
    return displayError(new Error('Your Browser does not support the HTTP Live Streaming Protocol'))
  }
  const hls = new Hls()
  hls.config.ipfs = g_ipfs_node
  hls.config.ipfsHash = v_cid
  hls.loadSource(src)  										//'master.m3u8'
  hls.attachMedia(video)
  hls.on(Hls.Events.MANIFEST_PARSED, () =>	 video.play())
  */
}


var g_app_populators = 
 {
	"blog" : (entry) => { 
		//
		if ( !(entry.abstract) ) {
			let abstract_tag = document.getElementById('floating-info-entry-include-abstract')
			abstract_tag.style.display = "none"
			return false
		}
		//
		let doc = document.getElementById('floating-info-special-type-blog')
		doc.innerHTML = !(entry.decoded) ? decodeURIComponent(entry.txt_full) : entry.txt_full
		//
		return true
	},
	"demo" : (entry) => { return false },
	"stream" : (entry) => { 
		let poster = document.getElementById('asset-type-stream-poster')
		poster.style.display = "none"
		let sound = document.getElementById('asset-type-stream-sound')
		sound.style.display = "none"
		let video = document.getElementById('asset-type-stream-video')
		video.style.display = "none"
		//
		let media = entry.media
		//
		let media_type = entry.media_type
		if ( media_type === 'image' ) {
			if ( poster ) {
				if ( entry.blob ) {
					poster.src = entry.blob
				} else {
					poster.src = media.poster
				}
				poster.style.display = "block"
			}
		} else if ( media_type === 'video' ) {
			if ( video ) {
				video.poster = media.poster
				if ( entry.blob && !(media.protocol)) {  // testing
					video.src = entry.blob
				} else if ( entry.use_protocol ) {
					let v_proto = media.protocol
					let v_cid = media[v_proto]
					let v_codec = {
						"type" : "video",
						"video" : 'video/mp4; codecs="avc1.64001e"'
					}
					media_startup(video,v_codec,v_proto,v_cid,media.source)
				} else {
					video.src = media.source
				}
				video.style.display = "block"
			}
		} else {	//  sound
			if ( sound ) {
				//let ext = extract_sound_media_ext(media.source)
				let sound_player = document.getElementById(`asset-type-stream-sound`)
				//let sound_player = document.getElementById(`asset-type-stream-sound-${ext}`)
				if ( sound_player ) {
					if ( entry.blob && !(media.protocol) ) {  // testing
						sound_player.src = entry.blob
					} else if ( entry.use_protocol ) {
						let a_proto = media.protocol		// a is for audio
						let a_cid = media[a_proto]
						let a_codec = {
							"type" : "audio",
							"audio" : 'audio/mp4; codecs="mp4a.40.2"'
						}
						media_startup(sound_player,a_codec,a_proto,a_cid,media.source)
					} else {
						sound_player.src = media.source
					}
					sound_player.style.display = "block"
				}
				if ( poster ) {
					poster.src = media.poster
				}
				sound.style.display = "block"
				poster.style.display = "block"
			}
		}
		
		return true 
	},
	"links" : (entry) => {
		let links = entry.links
		if ( links ) {
			let list = document.getElementById('asset-type-links-list')
			if ( list ) {
				list.innerHTML = ""
				let n = links.length
				for ( let i = 0; i < n; i++ ) {
					link = links[i]
					let element = document.createElement('li')
					let anchor = document.createElement('a')
					anchor.href = link
					anchor.id = `links-${i}-${entry._dash_entry_id}`  
					anchor.innerHTML = link
					anchor.target = "copious-check-links"  // tab name
					app_anchor_make_dragdrop_source(anchor)
					element.appendChild(anchor)
					list.appendChild(element)
				}
			}
		}
		return true
	}
}



function populate_special_fields(asset_type,id) {
	let index = get_index(id)
	let entries = g_all_user_entries[g_current_sel_display]
	let entry = entries[index]
	let populator = g_app_populators[asset_type]
	//
	let abstract_tag = document.getElementById('floating-info-entry-include-abstract')
	abstract_tag.style.display = "block"
	//
	return populator(entry)
}



//
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----

async function save(item_holder) {
	let cur_item_holder = document.getElementById(item_holder)
	let item_id = cur_item_holder.value
	let obj = get_object(item_id)
	//
	let title_holder = document.getElementById('floating-info-entry-title-field')
	let title = title_holder.value
	//
	obj.title = title
	let el_id = get_line_element(obj)
	//
	let line_el = document.getElementById(el_id)
	line_el.innerHTML = title
	//
	if ( obj._real_media ) {
		try {
			let [protocol,asset_id] = await do_media_upload(obj)
			if ( protocol && asset_id.length ) {
				obj.use_protocol = true
				if ( obj.media === undefined ) {
					obj.media = {}
				}
				obj.media.protocol = protocol
				obj.media[protocol] = asset_id
			}
		} catch (e) {
			//obj._real_media = false  // this is problematic, but if things are buggy, don't throw away data unexpectedly.
		}
	}
	//
	let saver = Object.assign({},obj)
	if ( obj._real_media ) {
		delete saver.blob			// don't store the blob that is uploaded
	}
	//
	real_save(saver)	// send the access record out
	delete g_unsaved_items[item_id]
	if ( obj.deleted ) {
		obj.deleted = false
		unpublish(item_holder)
	}
}


function publish(item_holder) {
	let cur_item_holder = document.getElementById(item_holder)
	let item_id = cur_item_holder.value
	let obj = get_object(item_id)
	real_publish(obj)
	let op_button_1 = document.getElementById('floating-info-entry-do-publish')
	let op_button_2 = document.getElementById('floating-info-entry-do-unpublish')
	op_button_1.disabled = true
	op_button_2.disabled = false
	let where_p = document.getElementById('floating-info-entry-published')
	where_p.innerHTML = "published"
	where_p.style.color = PUBLISHED_STATE_COLOR
	let index = g_current_entry_dom_map[obj._dash_entry_id]
	let el_id = `span-c${index}`
	let t_el = document.getElementById(el_id)
	if ( t_el ) t_el.style.color = PUBLISHED_COLOR


}

function unpublish(item_holder) {
	let cur_item_holder = document.getElementById(item_holder)
	let item_id = cur_item_holder.value
	let obj = get_object(item_id)
	real_unpublish(obj)
	let op_button_1 = document.getElementById('floating-info-entry-do-publish')
	let op_button_2 = document.getElementById('floating-info-entry-do-unpublish')
	op_button_1.disabled = false
	op_button_2.disabled = true
	let where_p = document.getElementById('floating-info-entry-published')
	where_p.innerHTML = "draft"
	where_p.style.color = UNPUBLISHED_STATE_COLOR
	let index = g_current_entry_dom_map[obj._dash_entry_id]
	let el_id = `span-c${index}`
	let t_el = document.getElementById(el_id)
	if ( t_el ) t_el.style.color = UNPUBLISHED_COLOR
}




// // // // // // // 
// // 
function op_on_checked(real_op,change) {
	let entries = g_all_user_entries[g_current_sel_display]
	if ( entries ) {
		let n = entries.length
		let op_list = []
		for ( let i = 0; i < n; i++ ) {
			let el_id = `c${i}`
			let el = document.getElementById(el_id) 
			if ( el && el.checked ) {
				el.checked = false
				let obj = entries[i]
				if ( !(obj.deleted) )  {
					op_list.push(obj)
					if ( typeof change === "function" ) {
						change(el)
					}
				}
			}
		}
		//
		op_list.forEach(item => {
			real_op(item)
		})
	}
}
// // // // // // // 



//
function publish_checked() {
	let op = (el) => {
		let el_id = `span-${el.id}`
		let t_el = document.getElementById(el_id)
		if ( t_el ) t_el.style.color = PUBLISHED_COLOR
		let obj = get_object(get_id(el_id))
		obj.published = true
	}
	op_on_checked(real_publish,op)
}

//
function unpublish_checked() {
	let op = (el) => {
		let el_id = `span-${el.id}`
		let t_el = document.getElementById(el_id)
		if ( t_el ) t_el.style.color = UNPUBLISHED_COLOR
		let obj = get_object(get_id(el_id))
		obj.published = false
	}
	op_on_checked(real_unpublish,op)
}

//
function reload_checked() {
	op_on_checked(real_reload)
}

//
function delete_checked() {
	let op = (el) => {
		let el_id = `span-${el.id}`
		let t_el = document.getElementById(el_id)
		if ( t_el ) t_el.style.color = DELETE_COLOR
		let obj = get_object(get_id(el_id))
		obj.deleted = true
	}
	op_on_checked(real_delete,op)
}

//
function hide_window(which) {
	let disp = document.getElementById(which)
	disp.style.display = "none"
	disp.style.visibility = "hidden"
}


// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----

function is_json_file(file) {
	let idx = file.indexOf(".json")
	if ( idx > 0 ) {
		if ( file.lastIndexOf('.') === idx ) {
			return true
		}
	}
	return false
}


function get_random_id(entries,nn) {
	let n = entries.length
	let rand_id = Math.floor(Math.random()*1000*(n+1)*(nn ? nn : 7)) + 600
	//
	let tst_id = rand_id
	let j = 0
	while ( (tst_id === rand_id) && (j < 20) ) {
		j++
		for ( let i = 0; i < n; i++ ) {
			tst_id = entries[i]._dash_entry_id
			if ( tst_id === rand_id ) {
				break
			}
		}
		rand_id = Math.floor(Math.random()*1000*(n+1)*(nn ? nn : 7)) + 600
	}
	if ( j < 20 ) return(rand_id)
	rand_id = Math.floor(Math.random()*600)
	return(rand_id)
}


//
//	done_with_file
//
function done_with_file(category,obj) {
	if ( obj === null ) {
		alert("no file loaded")
	} else {
		if ( category === "demo" ) {
			let ext = get_ext(obj.file_name)
			if ( ext !== '.json' ) {
				alert("the demo elements require a specific JSON format stored in a .json file")
				return;
			}
		}
		//
		let entries = g_all_user_entries[category]
		let new_dash_id = get_random_id(entries)
		obj._dash_entry_id = new_dash_id
		//
		if (  obj._real_media ) {
			let check_cat = check_category(category,obj.file_name)
			if ( check_cat !== category ) {
				category = check_cat
				// get the id again
				entries = g_all_user_entries[category]
				new_dash_id = get_random_id(entries)
				obj._dash_entry_id = new_dash_id
			}
			//	assign the media type...
			obj.media_type = best_fit_media_type(obj.file_name)
			switch ( obj.media_type ) {
				case 'audio' : {
					if ( obj.media === undefined ) {
						obj.media = {}
					}
					obj.media.poster = ""
					obj.media.source = make_audio_upload_link(obj)	// get the link that will serve this in a blog or other presentation services (upload later when saving)
					obj.blob = obj.result
					obj.result = "abstact required"
					break
				}
				case 'video' : {
					if ( obj.media === undefined ) {
						obj.media = {}
					}
					obj.media.poster = ""
					obj.media.source = make_video_upload_link(obj)	// get the link that will serve this in a blog or other presentation services (upload later when saving)
					obj.blob = obj.result
					obj.result = "abstact required"
					break
				}
				case 'image' : {
					if ( obj.media === undefined ) {
						obj.media = {}
					}
					obj.media.poster = make_image_upload_link(obj)	// get the link that will serve this in a blog or other presentation services (upload later when saving)
					obj.blob = obj.result
					obj.result = "abstact required"
					break;
				}
			}
		}
		if ( obj.media_type ) {
			if ( (obj.media_type === 'audio') || (obj.media_type === 'video') ) {
				category = 'stream'
			}
		}
		//
		let fname = obj.file_name
		let os_drop_result = obj.result
		let entry = {}
		if ( is_json_file(fname) ) {
			try {
				entry = JSON.parse(os_drop_result)		// contents of file is a JSON string (most likely)
			} catch (e) {
				entry = {
					"_dash_entry_id" : new_dash_id,
					"published" : false,
					'deleted' : false,
					'title' : obj.file_name,
					'data'  : obj.result			// guess again... just take the data along ... it will appear in the abstract field on displays
				}
				entry.file_name = obj.file_name
			}
		} else {
			entry = Object.assign({},obj)	// get the fields passed, carries:  mime, result, file_name, _real_media
			if ( obj.result ) {
				entry.data = obj.result		// known to be some kind of text format or other
			}
			delete entry.result
			entry.decoded = true
		}
		//
				// for use in the dashboard UI operations
		entry.deleted = false
		entry.published = false
		entry.file_name = obj.file_name			// use the one from the system if it got here from the file system
		if ( entry.title == undefined ) {
			entry.title = obj.file_name		// no title specified, so use the file name
		}
		if ( entry.txt_full && !( entry.abstract ) ) {		// a stuctured entry with a txt_full field, but without an abstract
			entry.data = entry.txt_full						// so put the text into the first text display... (usually abstract)  .. sort of fudgy
		}
		if ( (entry.abstract !== undefined) && (typeof entry.abstract === "string" ) ) {
			entry.data = entry.abstract				// abstract goes on display
		}
		if ( entry.data === undefined ) {			// Never got a version of data this dashboard knows about. So, tell the user to make some.
			entry.data = "Please enter a description"
		}
		entry.asset_type = category
		entries.push(entry)
		//
		g_unsaved_items[entry._dash_entry_id] = entry
		append_to_container(category,entry)
	}
}


function prepare_for_update(res) {
	let cat =  g_current_sel_display
	let cur_item_holder = document.getElementById('current-display-item')
	let id = cur_item_holder.value
	let obj = get_object(id)
	let clone = Object.assign({},obj)
	//
	if ( g_undo_list[cat][id] === undefined ) {
		g_undo_list[cat][id] = []
	}
	g_undo_list[cat][id].push(clone)
	//
	obj.data = res.result
	obj.title = res.file_name
	//
	let title_field = document.getElementById('floating-info-entry-title-field')
	title_field.value = obj.title
	//
}


function undo_data_drop(item_holder) {
	let cat =  g_current_sel_display
	let cur_item_holder = document.getElementById(item_holder)
	let id = cur_item_holder.value
	let undo_map = g_undo_list[cat]
	if ( undo_map ) {
		let undo_list = undo_map[id]
		if ( undo_list ) {
			let undo_obj = undo_list.pop()
			let obj = get_object(id)
			obj.title = undo_obj.title
			obj.data = undo_obj.data
			let edit_el = document.getElementById('floating-info-entry')
			if ( edit_el ) {
				edit_el.innerHTML = obj.data
			}
			let title_el = document.getElementById('floating-info-entry-title')
			title_el.innerHTML = obj.title
			let title_field = document.getElementById('floating-info-entry-title-field')
			title_field.value = obj.title
			//
			let el_id = get_line_element(obj)
			//
			let line_el = document.getElementById(el_id)
			line_el.innerHTML = obj.title
		}
	}
}

//
function prepare_file_text(text,file_name,category,mime) {
	//
	if ( file_name.indexOf('.') > 0 ) {
		let ext_pos = file_name.lastIndexOf('.')
		let ext = file_name.substr(ext_pos)
		if ( g_code_files.indexOf(ext) >= 0 ) {
			text = "<code>" + text + "</code>"
		}
	}
	//
	let res = {
				"result" : text,
				"file_name"   : file_name,
				"_real_media" : false,
				"mime" : mime
			}
	if ( category === 'update-only' ) {
		let edit_el = document.getElementById('floating-info-entry')
		if ( edit_el ) {
			edit_el.innerHTML = text
		}
		prepare_for_update(res)
	} else {
		done_with_file(category,res)
		show_stuff(category)
	}
	//
}


function prepare_file_blob(blob64,fname,category,mime) {
	if ( category === 'update-only' ) return;
	let res = {
		"result" : blob64,
		"file_name"   : fname,
		"_real_media" : true,
		"mime" : mime
	}
	done_with_file(category,res)
	show_stuff(category)
}


//
async function capture_clicks(ev,subst_key) {
		ev.preventDefault();
		// ask for a file
		/*
		try {
			let file = await request_file_browser()
			prepare_file_text(file.result,subst_key,file.fname)
		} catch (e) {
			alert("file could not be loaded")
		}
		*/
	}


// ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ----

function dropHandlerUpdates(ev) {
	ev.preventDefault();
	if ( ev.dataTransfer.items ) {
		// Use DataTransferItemList interface to access the file(s)
		for (let i = 0; i < ev.dataTransfer.items.length; i++) {
			if (ev.dataTransfer.items[i].kind === 'file') {
				let file = ev.dataTransfer.items[i].getAsFile();
				let fname = file.name
				let reader = new FileReader();
				reader.onload = (e) => {
					prepare_file_text(e.target.result,fname,'update-only',file.type)
				};
				reader.readAsText(file);
				break
			} else if (ev.dataTransfer.items[i].kind === 'string') {
				let maybe_url = ev.dataTransfer.items[i].getAsString()
				if ( matches_url(maybe_url) ) {
					add_or_use_url(maybe_url)
				}
			}
		}
	} else {
		// Use DataTransfer interface to access the file(s)
		for (let i = 0; i < ev.dataTransfer.files.length; i++) {
			let file = ev.dataTransfer.files[i].getAsFile();
			let fname = file.name
			var reader = new FileReader();
			reader.onload = (e) => {
				prepare_file_text(e.target.result,fname,'update-only',file.type)
			};
			reader.readAsText(file);
			break
		}
	}
}



// called in response to a file selection through the system file browser
//
function get_file(category) {
	let file_el = document.getElementById(`drop-click-file_loader-${category}`)
	file_el.addEventListener('change',(ev) => {
		let file = file_el.files[0]
		let fname =  file.name ? file.name : category_name_get(category)
		let mtype = best_fit_media_type(fname)
		let reader = new FileReader();
		if ( mtype == 'text' ) {
			reader.onload = (e) => {
				prepare_file_text(e.target.result,fname,category,file.type)
			};
			reader.readAsText(file);
		} else {
			reader.onload = (e) => {
				prepare_file_blob(e.target.result,fname,category,file.type)
			};
			reader.readAsDataURL(file)
		}
	})
	file_el.click()
}


// ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ----

function dropHandler(ev,category) {
	ev.preventDefault();
	if ( ev.dataTransfer.items ) {
		// Use DataTransferItemList interface to access the file(s)
		for (let i = 0; i < ev.dataTransfer.items.length; i++) {
			if (ev.dataTransfer.items[i].kind === 'file') {
				let file = ev.dataTransfer.items[i].getAsFile();
				let fname = file.name
				let mtype = best_fit_media_type(fname)
				var reader = new FileReader();
				if ( mtype == 'text' ) {
					reader.onload = (e) => {
						prepare_file_text(e.target.result,fname,category,file.type)
					};
					reader.readAsText(file);
				} else {
					reader.onload = (e) => {
						prepare_file_blob(e.target.result,fname,category,file.type)
					};
					reader.readAsDataURL(file)
				}
				break
			}
		}
	} else {
		// Use DataTransfer interface to access the file(s)
		for (let i = 0; i < ev.dataTransfer.files.length; i++) {
			let file = ev.dataTransfer.files[i].getAsFile();
			let fname = file.name
			let mtype = best_fit_media_type(fname)
			var reader = new FileReader();
			if ( mtype == 'text' ) {
				reader.onload = (e) => {
					prepare_file_text(e.target.result,fname,category,file.type)
				};
				reader.readAsText(file);
			} else {
				reader.onload = (e) => {
					prepare_file_blob(e.target.result,fname,category,file.type)
				};
				reader.readAsDataURL(file)
			}
			break
		}
	}
}

//
function dragOverHandler(ev,subst_key) {
	ev.preventDefault();
}



// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
/*
	{
		'owner' : user,
		'date'  : ('' + Date.now()),
		'panel_key' : generate_password(),
		'dashboard_text' : 'test dashboard_text'
		//obj.header_user_name = g_dashboard_info.header_user_name
		//obj.dashboard_text = dashboard_text
		//obj.tag_line = obj.tag_line
	}
*/
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----

var g_dashboard_info = null
// DELETE TESTING DATA

let shareable_field = document.getElementById("shareable")
g_dashboard_info.page_host = document.location.href   //document.location.hostname
shareable_field.value = JSON.stringify(g_dashboard_info)


//
// ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----

// sends the data file in an identifying packet to the backend for saving to a user directory...
async function real_save(obj) {
	obj.saved_ever = true
	let proxyPath = 'dashboard'
	let ky = g_current_sel_display
	let endpoint = `${location.protocol}//${g_siteURL}/${proxyPath}/transition/${ky}`
	if ( g_dashboard_info ) {		// later this will be fetched with uuid+${ky}+%{email}
		obj.user_name = g_dashboard_info.user_name
		let asset_id = `+${ky}+${obj.email}}`
		obj.email = g_dashboard_info.email
		obj.token = g_dashboard_info.token
		obj._origin = "popsong"
		let result = await postData(endpoint,obj)
	}
}

// these are just messages that send command to the back end to move or copy files from a user directory to a public one,
// or to remove it from a  public one (unpublish)

// copy a file from a user directory to a public one.
// this a published topic command...
async function real_publish(obj) {
	obj.published = true
	//
	let send_obj = Object.assign({},obj)
	delete send_obj.data			// for a command don't send all the data (it will be on the server)
	let proxyPath = 'dashboard'
	let endpoint = `${location.protocol}//${g_siteURL}/${proxyPath}/transition/dash-commands`
	send_obj.topic = "command-publish"
	send_obj.user_name = g_dashboard_info.user_name
	send_obj.email = g_dashboard_info.email
	send_obj.token = g_dashboard_info.token
	send_obj._origin = "popsong"
	let result = await postData(endpoint,send_obj) 	// send everything to be stored....
}

// remove a user's file from a public directory
async function real_unpublish(obj) {
	obj.published = false
	//
	let send_obj = Object.assign({},obj)
	delete send_obj.data			// for a command don't send all the data (it will be on the server)
	let proxyPath = 'dashboard'
	let endpoint = `${location.protocol}//${g_siteURL}/${proxyPath}/transition/dash-commands`
	send_obj.topic = "command-recind"
	send_obj.user_name = g_dashboard_info.user_name
	send_obj.email = g_dashboard_info.email
	send_obj.token = g_dashboard_info.token
	send_obj._origin = "popsong"	
	let result = await postData(endpoint,send_obj)
}

// fetch the file from the backend once again...
async function real_reload(obj) {
	// always keep the email inthe object
	obj.email = g_dashboard_info.email
	//
	let proxyPath = 'dashboard'
	let ky = g_current_sel_display
	let asset_id = `${obj._id}+${ky}+${obj.email}}`
	let endpoint = `${location.protocol}//${g_siteURL}/${proxyPath}/guarded/dynamic/${asset_id}`
	let send_obj = Object.assign({},obj)
	delete send_obj.data			// for a command don't send all the data (it will be on the server)
	send_obj.user_name = g_dashboard_info.user_name
	send_obj.token = g_dashboard_info.token
	send_obj._origin = "popsong"
	//
	let result = await postData(endpoint,obj)			// send everything and then update it on this page.
	if ( result.status === "OK" ) {
		let data = result.data
		obj.title = data.title
		obj.data = data.data
		obj._dash_entry_id = data._dash_entry_id
		obj.published = data.published
		obj.deleted = data.deleted
		obj.saved_ever = false
		show_stuff(g_current_sel_display)
		update_edit_display(obj)
	}
}


// this is a publish command that will decrement a refernce count to a file, ultimately unpinning it.
async function real_delete(obj) {
	if ( !(obj.saved_ever) ) {
		let index = g_current_entry_dom_map[obj._dash_entry_id]
		let div_container_id = `div-${index}`
		//
		let div_el = document.getElementById(div_container_id)
		div_el.parentNode.removeChild(div_el)
		//
		delete g_current_entry_dom_map[obj._dash_entry_id]
		// g_all_user_entries
		let entries = g_all_user_entries[g_current_sel_display]
		entries = entries.filter((entry) => {
			return(entry._dash_entry_id != obj._dash_entry_id)
		})
		g_all_user_entries[g_current_sel_display] = entries
		//
	} else {
		let send_obj = Object.assign({},obj)
		delete send_obj.data			// for a command don't send all the data (it will be on the server)
		let proxyPath = 'dashboard'
		let endpoint = `${location.protocol}//${g_siteURL}/${proxyPath}/transition/dash-commands`
		send_obj.topic = "command-delete"
		send_obj.user_name = g_dashboard_info.user_name
		send_obj.email = g_dashboard_info.email
		send_obj.token = g_dashboard_info.token
		send_obj._origin = "popsong"
		let result = await postData(endpoint,send_obj)
	}
}


var g_backup_edit_for_change = {}
//
function setChangeListener (div, listener) {
	div.addEventListener("blur", listener);
	div.addEventListener("keyup", listener);
	div.addEventListener("paste", listener);
	div.addEventListener("copy", listener);
	div.addEventListener("cut", listener);
	div.addEventListener("delete", listener);
	div.addEventListener("mouseup", listener);
}


function drop_content_aware() {
	//
	let target = document.getElementById("floating-info-entry")
	let title_el = document.getElementById("floating-info-entry-title-field")
	if ( target ) {
		target.addEventListener('focus',(ev) => {
			//
			let current_text = target.innerHTML
			let title = title_el.value
			g_backup_edit_for_change = {
				"result" : current_text,
				"file_name"   : title
			}
			//
		})
		//
		setChangeListener(target, (event) => {
			let current_text = target.innerHTML
			let title = title_el.value
			if ( g_backup_edit_for_change.result !== current_text ) {
				if ( event.type === "keyup" ) {
					let c = current_text[current_text.length-1]
					if ( (c !== ' ') || (c !== '\n') ) {
						return;
					}
				}
				let res = {
					"result" : current_text,
					"file_name"   : title
				}
				prepare_for_update(res)
			}
		});
	}
}


function setup_user_dashboard(dashboardResponse,session_token) {

	// this is a response object from the parent window....
	g_dashboard_info = dashboardResponse		// it becomes the dashboard info
	if ( session_token !== undefined ) {
		g_dashboard_info.token = session_token
	}
	
	// use the field in the info object to populate elements with the same names 
	// as the object field names
	for ( let ky in dashboardResponse ) {
		let el = document.getElementById(ky)
		if ( el ) {
			el.innerHTML = dashboardResponse[ky]
		}
	}
	//
	let _entries = g_dashboard_info.entries
	if ( _entries ) {
		for ( let ky in g_all_user_entries ) {
			if ( _entries[ky] !== undefined ) {
				g_all_user_entries[ky] = _entries[ky]
			}
		}
	}
	//
	g_dashboard_info.page_host = document.host
	let shar = document.getElementById("shareable")
	shar.value = JSON.stringify(g_dashboard_info)

	show_stuff('blog')
	drop_content_aware()
	//setTimeout(setup_ipfs_node,2000)
}


// handle logout from the main control point....
function site_wide_logout() {

}



window.addEventListener("message", (event) => {
  if (event.source == window &&
      event.data.direction &&
      event.data.direction == "from-content-script") {
	let message = event.data.message
	if ( typeof message === "string" ) {
		try {
			message = JSON.parse(message)
		} catch (e) {}
	}

	if ( event.data.category === "links" ) {
		message.mime = "application/json"
		done_with_file("links",message)
		show_stuff('links')
	}

    //alert("Page script received message: \"" + message + "\"");
  }
});

// DELETE TESTING SETUP
</script>
<script src="https://cdn.jsdelivr.net/npm/ipfs@latest/dist/index.js"></script>

<script>

async function setup_ipfs_node() {
	// Create an IPFS node inside the browser
	let node = false;
	// Init a new repo for this run
	const repoPath = 'ipfs-' + Math.random()
	try {
		// Instatiate an IPFS node
		node = await Ipfs.create({ repo: repoPath })
	} catch(err) {
		displayError(err)
	}
	g_ipfs_node = node
}



async function ipfs_add_media(file_name,blob_url) {

	//
	try {
		let res = await fetch(blob_url)
		let blob_data = await res.blob()
		//
		blob_data = store_encrypted(blob_data)
        //
        const file = await g_ipfs_node.add({
            path: file_name,
            content: blob_data
        })
		let cid = file.cid.toString()
		return(cid)
	} catch(e) {
		return
	}

}



//
//
//
// 'audio/mp4; codecs="mp4a.40.2"'
// 'video/mp4; codecs="avc1.64001e"'
/*
// for the audio SourceBuffer
fetch("http://server.com/audio.mp4").then(function(response) {
  // The data has to be a JavaScript ArrayBuffer
  return response.arrayBuffer();
}).then(function(audioData) {
 
});
*/

async function ipfs_loader(medial_el,codecs,hash_id) {
	//
	let endpoint = 'streamer/ipfs/'
	//
	if ( codecs.type == "audio" ) {
		endpoint = 'streamer/ipfs/'
	} else if ( codecs.type == "video" ) { 
		endpoint = 'movies/ipfs/'
	}
	//
	endpoint += hash_id
	//
	medial_el.src = `${location.protocol}//${g_siteURL}/${endpoint}`
	//
}



</script>
